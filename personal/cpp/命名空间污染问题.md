# 在项目中遇到的命名空间污染问题

##  起因
在赤壁项目中添加了一个新的效果 Deliver****
在实际运行中 调用TakeEff***时发现没有效果 且在之后的状态包释放环节崩溃

## 初步调式
1. 初步发现调用TakeEff时会直接调用了效果的析构函数 不知为何
2. 反复调试确认崩溃是因为 上面调用了析构 而状态包释放时 又会释放一遍 效果类 导致崩溃
3. 发现TakeEff调用后 指针的类型变成了 Marshal 不是Effect了
4. 上述情况让我想到了 符号表加载的有问题 但是没有往这边测试
5. 测试了其他的Effect的情况 测试了单独的Effect情况 就这一个新添的效果有问题
6. 故而尝试修改类名 结果成功了
7. 一开始以为是 task的那个so有重复的符号 nm确定没有
8. 后来nm gs发现确实有同名的 而且有Protocol Marshal相关的Deliver***
9. 至此确定为 命名空间污染 在加载动态库时 由于主程序已经加载了对应的符号动态库符号重定向失败，使用的是已有的

## 这里总结一些知识点
符号的重定位:
分为3中情况 链接时重定位 加载时重定位 运行时重定位

位置无关代码：
通过PIC寄存器 计算获得符号的地址 不管文件被加载到那个位置 都可以通过这种方式找到

PLT: Procedure Linkage Table, 进程链接表 用于解析外部函数地址 

延迟加载：os很多时候为了效率，会采用延迟加载 和不是启动时全都加载上

## 相关参考文章
- [一个动态库同名函数问题的解释](codeantenna.com/a/inbR7Yyams)
- [对got plt的详细说明](cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html)


